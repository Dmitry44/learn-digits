<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Learn Digits</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.x.x/css/pico.min.css" />
    <style>
        .custom-container {
            max-width: 600px;
            margin: 0 auto;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body x-data="data" @keydown.window.space.prevent="$refs.playButton.click()">
    <header class="container custom-container">
        <hgroup>
            <h1>Learn Digits</h1>
            <p>Train your number recognition by listening and typing</p>
        </hgroup>
    </header>

    <main class="container custom-container">
        <section id="ld-app">
            <div class="ld-options">
                <label for="ld-language">Language:</label>
                <select id="ld-language" x-model="language" @change="$refs.input.focus()">
                    <option value="en">English</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>
            <p class="ld-toolbar grid">
                <button @click="playing = !playing; $refs.input.focus();" x-ref="playButton">
                    <span x-show="!playing">Play</span>
                    <span x-show="playing">Pause</span>
                </button>
            </p>

            <div class="ld-input">
                <input type="number" inputmode="numeric" x-model="userInput" x-ref="input" placeholder="Type here" />
            </div>

        </section>
    </main>

    <footer class="container custom-container">
        <small>Â© 2025</small>
    </footer>

</body>

<script>
    const playAudio = (audio) => {
        audio.pause();
        audio.currentTime = 0;
        audio.play();
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('data', () => ({
            init() {
                this.$watch('userInput', () => {
                    this.checkInput();
                });
                this.$watch('playing', (val) => {
                    if (val) this.loadNextAudio('init')
                    else this.stopAudio();
                });
                this.successAudio.onended = () => this.loadNextAudio('successAudio.onended');
                this.errorAudio.onended = () => this.loadNextAudio('errorAudio.onended');
            },

            playing: false,
            language: 'en',
            currentAudio: null,
            userInput: '',
            playAttempts: 0,
            audioElement: null,
            successAudio: new Audio('audio/success.mp3'),
            errorAudio: new Audio('audio/error.mp3'),

            nextAudioLoading: false,
            loadNextAudio(e) {
                if (this.nextAudioLoading) return;
                console.log(e, this.userInput);
                this.nextAudioLoading = true;
                try {
                    this.stopAudio();
                    this.userInput = '';
                    this.playAttempts = 0;

                    let nextAudio;
                    let files = this[this.language].files
                    do {
                        nextAudio = files[Math.floor(Math.random() * files.length)];
                    } while (nextAudio?.input === this.currentAudio?.input);
                    this.currentAudio = nextAudio;

                    this.createAudioElement();
                    this.playAudio();
                }
                finally {
                    this.nextAudioLoading = false;
                }
            },

            createAudioElement() {
                if (!this.playing) return;
                this.audioElement = new Audio(this.currentAudio.file);
                this.audioElement.onended = () => {
                    this.playAttempts++;
                    if (this.playAttempts < 3) {
                        setTimeout(() => this.playAudio(), 1000);
                    } else {
                        this.playError();
                    }
                };
            },

            playAudio() {
                if (!this.playing) return;
                if (this.audioElement) {
                    this.audioElement.currentTime = 0;
                    this.audioElement.play();
                }
            },

            stopAudio() {
                if (this.audioElement) {
                    this.audioElement.pause();
                    this.audioElement.currentTime = 0;
                }
            },

            checkInput() {
                if (this.userInput === this.currentAudio.input) {
                    this.stopAudio();
                    this.playSuccess();
                }
                if (this.userInput && !this.currentAudio.input.startsWith(this.userInput)) {
                    this.userInput = '';
                }
            },

            playSuccess() {
                playAudio(this.successAudio);
            },

            playError() {
                playAudio(this.errorAudio);
            },

            en: { files:
                    [
                        { input: '1', file: 'audio/en/1.wav'},
                        { input: '2', file: 'audio/en/2.wav'},
                        { input: '3', file: 'audio/en/3.wav'},
                        { input: '4', file: 'audio/en/4.wav'},
                    ]
            },
            de: { files:
                    [
                        { input: '1', file: 'audio/de/1.mp3'},
                        { input: '2', file: 'audio/de/2.mp3'},
                        { input: '3', file: 'audio/de/3.mp3'},
                        { input: '4', file: 'audio/de/4.mp3'},
                        { input: '5', file: 'audio/de/5.mp3'},
                    ]
            },
        }))
    })
</script>

</html>`